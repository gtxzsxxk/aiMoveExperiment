<!DOCTYPE html>
<html>

<head>
    <title>Slew Simulator</title>
    <style>
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        canvas {
            /*border: 1px solid;*/
        }
    </style>
</head>

<body>
    <div id="app">
        <canvas id="canvas1" width="800" height="600">

        </canvas>
    </div>
    <!--script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script-->
    <script>
        let xyList = new Array();
        let mouseDown = false;
        let virgin = true;
        let counter = 0;
        let userPlaneData = {};
        let prenodes = null;
        const canvas = document.getElementById("canvas1");
        const ctx = canvas.getContext("2d");

        window.onload = () => {
            resizeCanvas();
            initialization();
            DrawPrenodePath();

        }
        window.onresize = () => resizeCanvas();

        function resizeCanvas() {
            canvas.width = document.documentElement.clientWidth;
            canvas.height = document.documentElement.clientHeight;
        }

        //let intr = window.setInterval(Draw, 33);

        function initialization() {
            prenodes = JSON.parse(prenode_json);
            userPlaneData = {
                x: prenodes[0][0],
                y: prenodes[0][1],
                heading: 0,
                ahead_rate: 0,
                yaw_rate: 0
            };

        }

        function DrawArrow(x, y, heading) {
            const unitlong = 30;
            let dx = Math.cos(heading * 3.14159 / 180) * unitlong;
            let dy = Math.sin(heading * 3.14159 / 180) * unitlong;
            ctx.strokeStyle = "rgba(128,64,233,0.8)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + dx, y + dy);
            const arrowheadlength = 15;
            let dx_a, dy_a;
            if (dy >= 0) {
                dx_a = Math.cos((heading+30+180) * 3.14159 / 180) * arrowheadlength;
                dy_a = Math.sin((heading+30+180) * 3.14159 / 180) * arrowheadlength;
            }
            else {
                dx_a = Math.cos((heading+30-180) * 3.14159 / 180) * arrowheadlength;
                dy_a = Math.sin((heading+30-180) * 3.14159 / 180) * arrowheadlength;
            }
            ctx.lineTo(x + dx + dx_a, y + dy + dy_a);
            let dx_b, dy_b;
            if (dy >= 0) {
                dx_b = Math.cos((heading-30+180) * 3.14159 / 180) * arrowheadlength;
                dy_b = Math.sin((heading-30+180) * 3.14159 / 180) * arrowheadlength;
            }
            else {
                dx_b = Math.cos((heading-30-180) * 3.14159 / 180) * arrowheadlength;
                dy_b = Math.sin((heading-30-180) * 3.14159 / 180) * arrowheadlength;
            }
            ctx.moveTo(x + dx, y + dy);
            ctx.lineTo(x + dx + dx_b, y + dy + dy_b);
            ctx.stroke();
        }

        function DrawPrenodePath() {
            //let prenodes = JSON.parse(prenode_json);
            //console.log(prenodes.length);
            ctx.strokeStyle = "rgba(0,0,0,0.5)";
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.moveTo(prenodes[0][0], prenodes[0][1]);
            for (let i = 1; i < prenodes.length; i++) {
                let px = prenodes[i][0];
                let py = prenodes[i][1];
                ctx.lineTo(px, py);
                //console.log("NODE:("+px+","+py+")");
            }
            ctx.stroke();
        }

        function calcHeading(x1, y1, x2, y2) {
            let dx = x2 - x1;
            let dy = y2 - y1;
            console.log("Delta:(" + dx + "," + dy + ")");
            if (dx == 0 && dy != 0) {
                return dy > 0 ? 90 : 270;
            }
            if (dy == 0) {
                return dx > 0 ? 0 : 180;
            }
            let tanTheta = dy / dx;
            if (dx > 0 && dy > 0) {
                return Math.atan(tanTheta) * 180 / 3.14159;
            }
            else if (dx < 0 && dy > 0) {
                return 180 + Math.atan(tanTheta) * 180 / 3.14159;
            }
            else if (dx < 0 && dy < 0) {
                return 180 + Math.atan(tanTheta) * 180 / 3.14159;
            }
            else if (dx > 0 && dy < 0) {
                return 360 + Math.atan(tanTheta) * 180 / 3.14159;
            }
        }

        window.setInterval(() => {
            var w = canvas.width;
            var h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            DrawPrenodePath();
            //console.log("refresh");
            //let prenodes = JSON.parse(prenode_json);
            let prevCounter = counter - 1;
            if (prevCounter < 0) prevCounter = prenodes.length - 1;
            let px = prenodes[prevCounter][0];
            let py = prenodes[prevCounter][1];
            let nx = prenodes[counter][0];
            let ny = prenodes[counter][1];
            let hdg = calcHeading(px, py, nx, ny);
            console.log(hdg);
            DrawArrow(nx, ny, hdg);
            DrawArrow(userPlaneData.x, userPlaneData.y, userPlaneData.heading);
            counter++;
            if (counter == prenodes.length) {
                counter = 0;
            }
        }, 33);


        function CalcPlane() {
            //飞机只有前进的速率，和旋转的速率两个自由度
            //let prenodes = JSON.parse(prenode_json);
            let nextNode = prenodes[counter];

        }

        function dataOptimist() {
            //let prenodes = JSON.parse(prenode_json);
            let oknodes = new Array();
            for (let i = 0; i < prenodes.length - 1; i++) {
                let j = i + 1;
                let dx = prenodes[j][0] - prenodes[i][0];
                let dy = prenodes[j][1] - prenodes[i][1];
                let dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 5) {
                    continue;
                }
                oknodes.push([prenodes[i][0], prenodes[i][1]]);
            }
            let json_str = JSON.stringify(oknodes);
            console.log(json_str);
        }

        let prenode_json = "[[361,110],[310,204],[313,232],[328,274],[335,285],[338,290],[341,294],[345,298],[352,307],[356,311],[361,316],[365,320],[371,325],[375,329],[380,334],[385,338],[391,342],[395,346],[401,350],[408,356],[413,360],[417,363],[425,368],[433,372],[439,377],[447,381],[453,386],[461,391],[469,395],[478,400],[488,404],[497,408],[503,411],[511,416],[519,419],[528,423],[539,428],[547,431],[558,434],[565,438],[573,440],[581,443],[589,446],[597,449],[605,451],[617,455],[627,458],[636,460],[647,463],[655,464],[671,468],[677,469],[686,470],[697,472],[707,474],[729,476],[748,476],[758,476],[770,477],[779,477],[789,477],[798,477],[812,477],[830,476],[839,476],[861,472],[871,471],[881,470],[891,468],[907,465],[913,464],[922,462],[932,460],[951,453],[957,451],[967,447],[979,441],[993,435],[1006,428],[1013,422],[1022,416],[1028,412],[1046,399],[1055,392],[1060,386],[1073,373],[1079,366],[1093,350],[1102,336],[1105,329],[1117,307],[1125,286],[1129,266],[1130,252],[1131,246],[1131,234],[1131,228],[1126,207],[1122,197],[1119,190],[1113,180],[1109,174],[1106,169],[1101,162],[1098,158],[1090,146],[1087,142],[1083,137],[1079,132],[1075,128],[1071,123],[1065,119],[1059,114],[1051,108],[1045,103],[1035,97],[1026,92],[1013,86],[1005,83],[994,80],[890,78],[880,81],[873,82],[864,85],[922,117],[939,129],[928,187],[922,190],[913,194],[896,196],[877,198],[869,198],[863,198],[850,200],[841,202],[825,211],[820,248],[956,248],[955,282],[947,288],[937,295],[931,298],[924,303],[917,307],[910,308],[895,310],[884,311],[871,311],[866,311],[859,311],[851,310],[841,310],[836,310],[830,310],[825,310],[879,357],[883,361],[893,367],[901,390],[895,396],[855,418],[847,419],[817,419],[812,418],[801,417],[791,415],[786,414],[779,413],[763,410],[753,409],[746,408],[741,408],[730,406],[725,405],[718,404],[707,402],[697,401],[692,400],[685,399],[680,398],[673,396],[637,373],[633,366],[625,354],[609,321],[608,315],[606,297],[606,286],[605,274],[605,268],[608,246],[609,240],[613,232],[615,227],[617,221],[621,212],[628,197],[631,189],[635,184],[637,177],[644,164],[648,158],[651,152],[656,144],[661,136],[665,132],[679,114],[683,110],[689,103],[706,89],[752,59],[768,52],[858,36],[874,35],[897,34],[905,34],[913,34],[979,29],[996,28],[1003,27],[1013,26],[1020,26],[1025,26],[1049,25],[1054,25],[1065,25],[1074,26],[1079,26],[1101,28],[1116,29],[1125,30],[1131,30],[1141,32],[1150,33],[1156,34],[1161,34],[1170,35],[1175,36],[1181,37],[1195,38],[1200,39],[1209,41],[1226,46],[1234,47],[1241,49],[1253,52],[1261,54],[1267,55],[1277,58],[1285,60],[1291,62],[1300,66],[1307,68],[1319,72],[1327,74],[1333,76],[1344,80],[1351,82],[1363,87],[1372,91],[1388,96],[1402,101],[1415,106],[1422,110],[1452,129],[1458,133],[1467,138],[1475,144],[1481,148],[1487,151],[1496,156],[1513,170],[1518,176],[1525,182],[1530,187],[1533,192],[1536,196],[1540,202],[1543,210],[1546,216],[1549,223],[1551,228],[1555,239],[1559,248],[1563,260],[1565,268],[1577,393],[1577,399],[1574,414],[1573,421],[1544,469],[1540,463],[1533,454],[1523,442],[1512,430],[1503,420],[1489,409],[1483,406],[1479,402],[1468,396],[1463,394],[1447,388],[1439,386],[1433,385],[1428,384],[1417,382],[1406,382],[1399,381],[1394,380],[1384,380],[1372,380],[1366,380],[1356,380],[1350,380],[1337,382],[1332,384],[1316,391],[1311,394],[1304,398],[1289,418],[1288,424],[1287,435],[1287,442],[1287,450],[1306,469],[1313,472],[1322,478],[1332,482],[1339,486],[1347,488],[1353,490],[1359,491],[1367,493],[1383,496],[1394,497],[1401,498],[1408,499],[1416,502],[1421,502],[1429,505],[1437,507],[1442,509],[1451,514],[1457,516],[1462,519],[1478,533],[1481,538],[1472,604],[1465,608],[1459,610],[1453,611],[1447,612],[1442,612],[1433,612],[1421,612],[1411,612],[1403,612],[1392,610],[1381,609],[1369,606],[1353,603],[1348,602],[1334,598],[1329,595],[1319,591],[1311,588],[1299,584],[1293,581],[1285,577],[1271,571],[1263,569],[1255,565],[1238,561],[1229,558],[1219,557],[1209,555],[1199,555],[1189,555],[1182,555],[1176,555],[1166,557],[1144,584],[1144,589],[1144,596],[1143,605],[1163,636],[1173,642],[1195,652],[1207,654],[1217,656],[1235,658],[1244,658],[1261,660],[1268,662],[1283,664],[1299,665],[1305,666],[1317,666],[1327,667],[1337,669],[1361,674],[1369,676],[1377,679],[1386,685],[1391,690],[1397,695],[1401,700],[1399,732],[1393,736],[1385,743],[1378,747],[1367,753],[1357,758],[1347,761],[1341,762],[1328,762],[1318,762],[1310,762],[1305,762],[1290,762],[1280,762],[1269,762],[1260,761],[1249,761],[1239,760],[1229,759],[1223,758],[1214,756],[1207,756],[1199,755],[1191,754],[1186,754],[1176,752],[1171,752],[1161,750],[1141,744],[1131,739],[1124,735],[1116,732],[1112,729],[1107,726],[1102,724],[1096,721],[1091,719],[1084,716],[1075,712],[1063,708],[1055,705],[1049,702],[1042,699],[1031,694],[1026,692],[1021,690],[1016,687],[1009,684],[968,675],[961,675],[953,675],[941,679],[925,686],[915,694],[905,721],[911,724],[919,729],[924,731],[929,733],[939,738],[945,741],[951,744],[939,776],[933,778],[927,779],[915,779],[901,778],[892,776],[885,774],[877,771],[871,769],[863,766],[855,762],[850,759],[843,756],[837,752],[829,748],[823,743],[815,738],[809,734],[801,729],[793,724],[773,708],[765,700],[758,688],[757,682],[757,674],[758,666],[761,656],[765,642],[767,626],[769,617],[783,596],[789,591],[831,578],[839,577],[844,577],[854,576],[862,576],[873,574],[883,570],[890,568],[879,538],[837,554],[822,558],[815,559],[805,562],[799,563],[792,564],[785,566],[778,567],[773,568],[767,570],[761,572],[719,582],[662,599],[627,624],[621,637],[618,648],[615,661],[613,670],[610,690],[609,698],[609,704],[607,710],[605,716],[565,760],[552,761],[543,762],[538,762],[533,762],[528,762],[523,762],[518,762],[509,762],[502,760],[496,760],[491,759],[482,758],[446,750],[400,737],[349,712],[340,704],[337,700],[329,686],[325,679],[321,669],[316,654],[313,647],[311,642],[309,636],[306,630],[304,624],[301,618],[297,609],[291,600],[289,594],[285,590],[283,585],[281,580],[278,575],[273,570],[270,564],[266,558],[261,551],[257,545],[251,538],[247,532],[240,522],[235,516],[231,512],[227,506],[224,502],[219,494],[213,486],[210,481],[205,476],[201,470],[197,464],[191,455],[184,447],[180,442],[176,437],[173,431],[170,426],[167,422],[165,415],[161,407],[157,398],[151,388],[142,370],[134,350],[130,333],[128,326],[125,310],[123,298],[121,289],[119,281],[118,267],[117,262],[117,251],[116,242],[115,234],[114,224],[113,213],[111,202],[111,191],[111,181],[114,174],[116,166],[117,161],[121,146],[127,129],[134,120],[165,92],[229,54],[234,52],[239,51],[256,47],[269,45],[279,44],[293,44],[332,50]]";
    </script>

</body>

</html>